(function(){var app=angular.module("messages.controllers",["ang-dialogs","angular.backtop","messages.directives.message-views","messages.services.message-list","users.directives.user-list","ui.bootstrap"]);app.controller("MessageListController",function($rootScope,$scope,$http,$dialogs,APP_EVENTS,MessageList){this.retrieveMessagesData=function(group,force){$scope.setLoading(true);if(MessageList.getOld()>1||force){$http($rootScope.getHttpRequestConfig("GET","message-rest",{headers:{"Content-Type":"application/json"}})).then(function successCallback(response){$scope.isLoading=false;$scope.messages=MessageList.setMessages(response.data).getMessages();$scope.filteredMessages=$scope.messages.length;$scope.unread=0;for(var i in $scope.messages){if(!$scope.messages[i].read){$scope.unread++}}$scope.setLoading(false)},function errorCallback(response){$scope.setLoading(false);debugger;var message="Failed while retrieving the messages list.";$dialogs.showErrorDialog(message,{logMessage:message+" at MessageListController:retrieveMessagesData."});console.error(response.data)})}else{$scope.messages=MessageList.getMessages();$scope.filteredMessages=$scope.messages.length;$scope.unread=0;for(var i in $scope.messages){if(!$scope.messages[i].read){$scope.unread++}}$scope.setLoading(false)}return this};$scope.filterMessages=function(){$scope.filteredMessages=0;$scope.user_id=$scope.user_id||Cookies.get("loggedUserID");return function(item){if($scope.show==="unread"){return!item.read}if($scope.show!=="all"){return item.type===$scope.show}var filterAux,item_tags;for(var i in $scope.filters){filterAux=$scope.filters[i].toLowerCase();if(!(item.message_name.toLowerCase().indexOf(filterAux)!==-1||item.description.toLowerCase().indexOf(filterAux)!==-1)){return false}}$scope.filteredMessages++;return true}};$scope.$on(APP_EVENTS.messageDeleted,function(event,args){debugger;this.retrieveMessagesData("",true)});this.changeCurrentMessageHandler=function(message){if($scope.action!=="new-message"){$scope.currentMessage=message;if(!$scope.currentMessage.read){$scope.currentMessage.read=true;$scope.unread--;$http($rootScope.getHttpRequestConfig("PUT","message-rest",{headers:{"Content-Type":"application/json"},extra:message.message_id,data:{message_json_data:$scope.currentMessage}})).then(function successCallback(response){},function errorCallback(response){debugger;var message="Failed while updating the message.";$dialogs.showErrorDialog(message,{logMessage:message+" at MessageListController:changeCurrentMessageHandler."});console.error(response.data)})}}};this.startNewMessageHandler=function(){if($scope.action!=="new-message"){$scope.action="new-message";$scope.newMessage.users.length=0;$scope.newMessage.subject="";$scope.newMessage.content=""}};this.replyMessageHandler=function(message){if($scope.action!=="new-message"){$scope.action="new-message";$scope.newMessage.users.length=0;$scope.newMessage.users.push(message.sender);$scope.newMessage.subject="Re: "+message.subject.replace(/^Re: /,"");$scope.newMessage.content=""}};this.sendNewMessageHandler=function(){var to="";for(var i in $scope.newMessage.users){to+=$scope.newMessage.users[i].user_id+", "}$scope.newMessage.users.push({user_id:Cookies.get("loggedUserID")});var total=$scope.newMessage.users.length;for(var i in $scope.newMessage.users){$http($rootScope.getHttpRequestConfig("POST","message-rest",{headers:{"Content-Type":"application/json"},data:{message_json_data:{user_id:$scope.newMessage.users[i].user_id,sender:Cookies.get("loggedUserID"),to:to,subject:$scope.newMessage.subject,content:$scope.newMessage.content,type:$scope.newMessage.users[i].user_id===Cookies.get("loggedUserID")?"sent":"message"}}})).then(function successCallback(response){total--;if(total===0){$scope.action=null;me.retrieveMessagesData(null,true)}},function errorCallback(response){debugger;var message="Failed while sending the new message.";$dialogs.showErrorDialog(message,{logMessage:message+" at MessageListController:sendNewMessageHandler."});console.error(response.data);total--;if(total===0){me.retrieveMessagesData(null,true)}})}};this.deleteMessageHandler=function(message){$http($rootScope.getHttpRequestConfig("DELETE","message-rest",{headers:{"Content-Type":"application/json"},extra:message.message_id})).then(function successCallback(response){delete $scope.currentMessage;me.retrieveMessagesData(null,true)},function errorCallback(response){debugger;var message="Failed while deleting the message.";$dialogs.showErrorDialog(message,{logMessage:message+" at MessageListController:deleteMessageHandler."});console.error(response.data)})};this.applySearchHandler=function(){var filters=arrayUnique($scope.filters.concat($scope.searchFor.split(" ")));$scope.filters=MessageList.setFilters(filters).getFilters()};this.filterByTag=function(tag){if(tag!=="All"){var filters=arrayUnique($scope.filters.concat(tag));$scope.filters=MessageList.setFilters(filters).getFilters()}};this.removeFilterHandler=function(filter){$scope.filters=MessageList.removeFilter(filter).getFilters()};this.name="MessageListController";var me=this;$scope.messages=MessageList.getMessages();$scope.filters=MessageList.getFilters();$scope.filteredMessages=$scope.messages.length;$scope.unread=0;for(var i in $scope.messages){if(!$scope.messages[i].read){$scope.unread++}}$scope.newMessage={users:[]};this.retrieveMessagesData("my_messages",true)})})();