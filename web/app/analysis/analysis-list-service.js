(function(){var app=angular.module("analysis.services.analysis-list",[]);app.factory("AnalysisList",["$rootScope",function($rootScope){var analysis=[];var newAnalysis=null;var tags=[];var analysisTypes=[];var filters=[];var tagColors=["yellow","green","red","blue","purple","pink","yellow2","green2","red2","blue2","purple2","pink2"];var old=new Date(0);return{getAnalysis:function(){return analysis},setAnalysis:function(_analysis){analysis=this.adaptInformation(_analysis);old=new Date;return this},setNewAnalysis:function(_analysis){newAnalysis=_analysis;return this},findAnalysis:function(analysis_id){for(var i in analysis){if(analysis[i].analysis_id===analysis_id){return analysis[i]}}return newAnalysis},findStep:function(step_id){var analysis=this.findAnalysis(step_id.split(".")[0].replace("ST","AN"));if(analysis){var steps=analysis.non_processed_data.concat(analysis.processed_data);for(var i in steps){if(steps[i].step_id===step_id){return steps[i]}}}return null},getParents:function(step_id,propertyName){propertyName=propertyName||"used_data";var parents=[];var step=this.findStep(step_id);if(step[propertyName]!==undefined&&step[propertyName]instanceof Array){var parent_ids=step[propertyName];for(var i in parent_ids){parents.push(this.findStep(parent_ids[i]))}}return parents},addAnalysis:function(_analysis){var previous=this.findAnalysis(_analysis.analysis_id);if(previous===null){analysis.push(_analysis)}else{return this.updateAnalysis(_analysis)}this.updateTags();this.updateAnalysisTypes();return analysis},updateAnalysis:function(_analysis){var previous=this.findAnalysis(_analysis.analysis_id);if(previous!==null){for(var i in _analysis){previous[i]=_analysis[i]}}this.updateTags();this.updateAnalysisTypes();return previous},deleteAnalysis:function(analysis_id){for(var i in analysis){if(analysis[i].analysis_id===analysis_id){analysis.splice(i,1);break}}this.updateTags();this.updateAnalysisTypes();return this},clearAnalysis:function(){analysis=[];tags=[];analysisTypes=[];filters=[];return this},getTags:function(){return tags},getTag:function(_tag){for(var i in tags){if(tags[i].name===_tag){return tags[i]}}return null},setTags:function(_tags){tags=_tags;return this},updateTags:function(){var tagsAux={},_tags;for(var i in analysis){_tags=analysis[i].tags;for(var j in _tags){tagsAux[_tags[j]]={name:_tags[j],times:tagsAux[_tags[j]]===undefined?1:tagsAux[_tags[j]].times+1}}}tags.length=0;for(var i in tagsAux){tags.push(tagsAux[i])}for(var i in tags){tags[i].color=tagColors[i%tagColors.length]}tags.push({name:"All",times:analysis.length});return this},getAnalysisTypes:function(){return analysisTypes},setAnalysisTypes:function(_analysisTypes){analysisTypes=_analysisTypes;return this},updateAnalysisTypes:function(){var typesAux={},_type;for(var i in analysis){typesAux[analysis[i].analysis_type]=1}analysisTypes.length=0;analysisTypes.push("All analysis types");for(var i in typesAux){analysisTypes.push(i)}return this},getFilters:function(){return filters},setFilters:function(_filters){filters=_filters;return this},removeFilter:function(_filter){var pos=filters.indexOf(_filter);if(pos!==-1){filters.splice(pos,1)}return this},getOld:function(){return(new Date-old)/6e4},adaptInformation:function(_analysis){for(var i in _analysis){_analysis[i].analysis_name=_analysis[i].analysis_name||"Unnamed analysis";_analysis[i].tags=_analysis[i].tags||[];_analysis[i].tags.push(_analysis[i].analysis_type);_analysis[i].tags=arrayUnique(_analysis[i].tags,[""]);_analysis[i].isRemoved=_analysis[i].remove_requests.indexOf(Cookies.get("loggedUserID"))!==-1;var maxStep=0;var steps=(_analysis[i].processed_data||[]).concat(_analysis[i].non_processed_data||[]);for(var j in steps){maxStep=Math.max(maxStep,Number.parseInt(steps[j].step_id.split(".")[1]))}_analysis[i].nextStepID=maxStep+1;this.adaptStepInformation(_analysis[i].non_processed_data);this.adaptStepInformation(_analysis[i].processed_data);this.updateStepIndexes(_analysis[i])}return _analysis},adaptStepInformation:function(steps){for(var i in steps){var date=steps[i].submission_date;if(date.indexOf("/")===-1){date=date.substr(0,4)+"/"+date.substr(4,2)+"/"+date.substr(6,2)}steps[i].submission_date=new Date(date);date=steps[i].last_edition_date;if(date.indexOf("/")===-1){date=date.substr(0,4)+"/"+date.substr(4,2)+"/"+date.substr(6,2)}steps[i].last_edition_date=new Date(date);if(steps[i].type==="intermediate_data"){steps[i].intermediate_data_type=steps[i].intermediate_data_type[0].toUpperCase()+steps[i].intermediate_data_type.substr(1);steps[i].intermediate_data_type=steps[i].intermediate_data_type.replace("_step","")}else if(steps[i].type==="processed_data"){steps[i].processed_data_type=steps[i].processed_data_type[0].toUpperCase()+steps[i].processed_data_type.substr(1);steps[i].processed_data_type=steps[i].processed_data_type.replace("_step","")}else{steps[i].analyticalReplicate_id=steps[i].analyticalReplicate_id||null}for(var key in steps[i].other_fields){if(!Number.isNaN(Number.parseFloat(steps[i].other_fields[key]))){steps[i].other_fields[key]=steps[i].other_fields[key]-0}}}return steps},updateStepIndexes:function(analysis){var all_steps={},already_set={},step;var updateRec=function(step,level){var maxLevel=level;if(!already_set[step.step_id]){step.step_number=level;already_set[step.step_id]=step;for(var i in step.used_data){maxLevel=Math.max(maxLevel,updateRec(all_steps[step.used_data[i]],level+1))}}else{if(step.step_number<level){step.step_number=level;for(var i in step.used_data){maxLevel=Math.max(maxLevel,updateRec(all_steps[step.used_data[i]],level+1))}}else{maxLevel=step.step_number}}return maxLevel};var steps=(analysis.processed_data||[]).concat(analysis.non_processed_data||[]);for(var i in steps){all_steps[steps[i].step_id]=steps[i]}var maxLevel=-1;for(var i in steps){maxLevel=Math.max(maxLevel,updateRec(steps[i],0))}var nextNumber=1;for(var level=maxLevel;level>=0;level--){for(var i=steps.length-1;i>=0;i--){if(steps[i].step_number===level){steps[i].step_number=nextNumber;steps.splice(i,1);nextNumber++}}}},isOwner:function(analysis,user_id){if(!analysis.non_processed_data&&!analysis.processed_data){return false}var steps=analysis.non_processed_data.concat(analysis.processed_data);for(var i in steps){for(var j in steps[i].step_owners){if(steps[i].step_owners[j].user_id===user_id){return true}}}return false},isStepOwner:function(step,user_id){for(var i in step.step_owners){if(step.step_owners[i].user_id===user_id){return true}}return false},isMember:function(analysis,user_id){for(var i in analysis.analysis_members){if(analysis.analysis_members[i].user_id===user_id){return true}}return false},hasChangedStep:function(newValues,oldValues){if((newValues===undefined||oldValues===undefined)&&newValues!==oldValues){return true}if(newValues instanceof Array){if(!oldValues instanceof Array||newValues.length!==oldValues.length){return true}for(var i in newValues){var hasChanged=this.hasChangedStep(newValues[i],oldValues[i]);if(hasChanged){return true}}}else if(newValues instanceof Object){if(!oldValues instanceof Object){return true}var newKeys=Object.keys(newValues).filter(function(key){return key!=="status"&&key!=="step_number"&&key[0]!=="$"});var oldKeys=Object.keys(newValues).filter(function(key){return key!=="status"&&key!=="step_number"&&key[0]!=="$"});if(newKeys.length!==oldKeys.length){return true}for(var i in newKeys){var hasChanged=this.hasChangedStep(newValues[newKeys[i]],oldValues[newKeys[i]]);if(hasChanged){return true}}}else{return newValues!==oldValues}},updateModelStatus:function(model,newStatus){if(newStatus==="undo"){if(model.status==="deleted"){delete model.status}if(model.status==="new_deleted"){model.status="new"}if(model.status==="edited"){delete model.status}if(model.status==="edited_deleted"){model.status="edited"}}else{if(model.status==="new"){if(newStatus==="deleted"){model.status="new_deleted"}}else if(model.status==="edited"){if(newStatus==="deleted"){model.status="edited_deleted"}}else if(model.status===undefined){if(newStatus==="deleted"){model.status="deleted"}else if(newStatus==="edited"){model.status="edited"}}}},checkLoop:function(current_step_id,new_step_id,propertyName){propertyName=propertyName||"used_data";var parents=this.getParents(current_step_id,propertyName);if(parents.length>0){for(var i in parents){if(parents[i].step_id===new_step_id){return true}}for(var i in parents){if(this.checkLoop(parents[i].step_id,new_step_id,propertyName)){return true}}}return false}}}])})();