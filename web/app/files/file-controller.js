(function(){var app=angular.module("files.controllers",["ang-dialogs","ui.router","files.services.file-list","ui.bootstrap"]);app.controller("FileListController",function($state,$rootScope,$scope,$http,$dialogs,$uibModal,FileList){this.retrieveFilesData=function(force){$scope.isLoading=true;if(FileList.getOld()>1||force){$http($rootScope.getHttpRequestConfig("GET","file-rest",{headers:{"Content-Type":"application/json"}})).then(function successCallback(response){$scope.isLoading=false;$scope.filesTree=FileList.setFilesTree(response.data).getFilesTree();$scope.files=FileList.getFiles();$scope.filteredFiles=$scope.files.length},function errorCallback(response){$scope.isLoading=false;debugger;var message="Failed while retrieving the files list.";$dialogs.showErrorDialog(message,{logMessage:message+" at FileListController:retrieveFilesData."});console.error(response.data)})}else{$scope.files=FileList.getFiles();$scope.filters=FileList.getFilters();$scope.filteredFiles=$scope.files.length;$scope.filesTree=FileList.getFilesTree();$scope.isLoading=false}return this};$scope.filterFiles=function(){$scope.filteredFiles=0;return function(item){var filterAux,item_tags;for(var i in $scope.filters){filterAux=$scope.filters[i].toLowerCase();item_tags=item.tags.join("");if(!(item.name.toLowerCase().indexOf(filterAux)!==-1||item_tags.toLowerCase().indexOf(filterAux)!==-1)){return false}}$scope.filteredFiles++;return true}};$scope.isSelectedFile=function(file){if($scope.models!==null){for(var i in $scope.models){if($scope.models[i].file_id===file.file_id){return true}}}return false};this.selectNewFileHandler=function(){$("#uploadFileSelector").click()};this.uploadFileHandler=function(nItem){this.removeAllowed=false;if(nItem===undefined){nItem=0}if($scope.uploadFiles===undefined){this.removeAllowed=true;return}if(nItem===$scope.uploadFiles.length){this.removeAllowed=true;me.retrieveFilesData(true);return}var file=$scope.uploadFiles[nItem];if(file.state!=="pending"){this.removeAllowed=true;me.uploadFileHandler(nItem+1);return}var formData=new FormData;formData.append("file_data",file);file.state="uploading";$http($rootScope.getHttpRequestConfig("POST","file-rest",{data:formData,headers:{"Content-Type":undefined},config:{transformRequest:angular.identity}})).then(function successCallback(response){file.state="done";me.uploadFileHandler(nItem+1)},function errorCallback(response){file.state="error";me.uploadFileHandler(nItem+1);debugger;console.error("Error while uploading a new file at FileListController:uploadFileHandler.");console.error(response)})};this.deleteToUploadFileHandler=function(selectedItem){$("#uploadFileSelector").val("");for(var i in $scope.uploadFiles){if($scope.uploadFiles[i]===selectedItem){$scope.uploadFiles.splice(i,1);return}}};this.changeSelectedFilesButtonHandler=function(){$scope.isDialog=true;$scope.browseDialog=$uibModal.open({templateUrl:"app/files/file-list.tpl.html",size:"lg",controller:"FileListController",controllerAs:"controller",scope:$scope});return this};this.closeBrowseDialogHandler=function(){$scope.browseDialog.dismiss("cancel");delete $scope.browseDialog};this.addSelectedFile=function(file){if($scope.models!==null){for(var i in $scope.models){if($scope.models[i].file_id===file.file_id){return this}}$scope.models.push(file)}return this};this.removeSelectedFile=function(file){if($scope.models!==null){for(var i in $scope.models){if($scope.models[i].file_id===file.file_id){$scope.models.splice(i,1);return this}}}return this};this.addManualLocationsHandler=function(manual_entries){if($scope.models!==null&&manual_entries!==""){var entries=manual_entries.split("\n");for(var i in entries){$scope.models.push(entries[i])}}return this};this.updateFileSelectionHandler=function(){$scope.filesTree;var selectedNodes=$("#files-tree-container").data("treeview").getChecked();var selection=[];for(var i in $scope.models){selection.push($scope.models[i])}for(var i in selectedNodes){if(selectedNodes[i].nodes===undefined){var name=selectedNodes[i].text;var parent=$("#files-tree-container").data("treeview").getParent(selectedNodes[i].nodeId);while(parent!==undefined){name=parent.text+"/"+name;parent=$("#files-tree-container").data("treeview").getParent(parent.nodeId)}selection.push(name)}}selection=arrayUnique(selection);$scope.models.length=0;for(var i in selection){$scope.models.push(selection[i])}return this};this.applySearchHandler=function(){$("#files-tree-container").data("treeview").search($scope.searchFor.search,{ignoreCase:true,exactMatch:false,revealResults:true})};var me=this;$scope.files=FileList.getFiles();$scope.filters=FileList.getFilters();$scope.filteredFiles=$scope.files.length;$scope.filesTree=FileList.getFilesTree();$scope.uploadFiles=[];if($scope.isDialog===true){$scope.searchFor={search:""};this.retrieveFilesData()}})})();